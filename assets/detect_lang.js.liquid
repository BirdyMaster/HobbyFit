(function() {
  console.log(window.Shopify)

  const cookie_country = getCookie('user_country');
  const cookie_lang = getCookie('user_lang');
  // Check if the cookie is already set
  if (cookie_country && cookie_lang) {
    return
  }

  detectLocalization();

  function detectLocalization() {
    fetch(`${window.Shopify.routes.root}browsing_context_suggestions.json?country[enabled]=true&country[exclude]=${window.Shopify.country}&language[enabled]=true&language[exclude]=${window.Shopify.language}`)
      .then(response => response.json())
      .then(data => {
        const detectedCountry = data.detected_values.country.handle;
        let detectedLanguage = '';

        // Check the detected country and set the detected language accordingly
        if (detectedCountry === 'DE') {
          detectedLanguage = 'de';
        } else if (detectedCountry === 'LT') {
          detectedLanguage = 'lt';
        } else {
          detectedLanguage = 'en';
        }


        // Save the detected country and language as a cookie
        setCookie('user_country', detectedCountry, 14);
        setCookie('user_lang', detectedLanguage, 14);

        // Update the localization using the detected values
        updateLocalization({ country: detectedCountry, language: detectedLanguage });
        
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  function updateLocalization({ country, language }) {
    const formId = crypto.randomUUID();
    const formHtml = `
      <form id="${formId}" action="/localization" method="POST" hidden>
        <input name="_method" value="PUT">
        <input name="country_code" value="${country}">
        <input name="language_code" value="${language}">
      </form>
    `;
    document.body.insertAdjacentHTML('beforeend', formHtml);
    document.getElementById(formId).submit();
  }

  function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
  }

  function getCookie(name) {
    const cookieValue = document.cookie.match(`(^|;)\\s*${name}=([^;]+)`);
    return cookieValue ? cookieValue[2] : null;
  }

  
})();